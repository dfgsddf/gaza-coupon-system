<?php

namespace Database\Seeders;

use Illuminate\Database\Console\Seeds\WithoutModelEvents;
use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\DB;
use App\Models\User;
use App\Models\Store;
use App\Models\Organization;
use App\Models\CharityOrganization;
use App\Models\BeneficiaryProfile;
use App\Models\Beneficiary;
use App\Models\RequestModel;
use App\Models\Coupon;
use App\Models\Transaction;
use App\Models\Campaign;
use App\Models\ContactMessage;
use App\Models\Permission;

class TestDataSeeder extends Seeder
{
    /**
     * Run the database seeds.
     */
    public function run(): void
    {
        $this->command->info('๐ ุจุฏุก ุฅูุดุงุก ุงูุจูุงูุงุช ุงูุงุฎุชุจุงุฑูุฉ...');

        DB::statement('SET FOREIGN_KEY_CHECKS=0;');

        // 1. ุฅูุดุงุก ุงููุณุชุฎุฏููู ุงูุฃุณุงุณููู
        $this->createBasicUsers();
        
        // 2. ุฅูุดุงุก ุงูุฃุฐููุงุช
        $this->createPermissions();
        
        // 3. ุฅูุดุงุก ุงูููุธูุงุช ูุงููุคุณุณุงุช ุงูุฎูุฑูุฉ
        $this->createOrganizations();
        
        // 4. ุฅูุดุงุก ุงููุชุงุฌุฑ
        $this->createStores();
        
        // 5. ุฅูุดุงุก ุงูุญููุงุช
        $this->createCampaigns();
        
        // 6. ุฅูุดุงุก ุงููุณุชููุฏูู ููููุงุชูู
        $this->createBeneficiaries();
        
        // 7. ุฅูุดุงุก ุงูุทูุจุงุช
        $this->createRequests();
        
        // 8. ุฅูุดุงุก ุงูููุจููุงุช
        $this->createCoupons();
        
        // 9. ุฅูุดุงุก ุงููุนุงููุงุช
        $this->createTransactions();
        
        // 10. ุฅูุดุงุก ุฑุณุงุฆู ุงูุงุชุตุงู
        $this->createContactMessages();
        
        // 11. ุฅูุดุงุก ุงูุนูุงูุงุช
        $this->createRelationships();

        DB::statement('SET FOREIGN_KEY_CHECKS=1;');

        $this->command->info('โ ุชู ุฅูุดุงุก ุฌููุน ุงูุจูุงูุงุช ุงูุงุฎุชุจุงุฑูุฉ ุจูุฌุงุญ!');
    }

    private function createBasicUsers(): void
    {
        $this->command->info('๐ ุฅูุดุงุก ุงููุณุชุฎุฏููู ุงูุฃุณุงุณููู...');

        // ูุณุชุฎุฏู ุงูุฅุฏุงุฑุฉ ุงูุฑุฆูุณู
        User::updateOrCreate(
            ['email' => 'admin@gaza-coupon.com'],
            [
                'name' => 'ูุฏูุฑ ุงููุธุงู',
                'role' => 'admin',
                'status' => 'active',
                'password' => bcrypt('password123'),
                'email_verified_at' => now(),
            ]
        );

        // ูุฏูุฑูู ุฅุถุงูููู - ููุท ุฅุฐุง ูู ููู ูุฏููู ุฃุฏูู ูุงูู
        $existingAdmins = User::where('role', 'admin')->count();
        if ($existingAdmins < 4) {
            $neededAdmins = 4 - $existingAdmins;
            User::factory($neededAdmins)->create([
                'role' => 'admin',
                'status' => 'active',
            ]);
        }

        $this->command->info('โ ุชู ุฅูุดุงุก ' . User::where('role', 'admin')->count() . ' ูุฏูุฑูู');
    }

    private function createPermissions(): void
    {
        $this->command->info('๐ ุฅูุดุงุก ุงูุฃุฐููุงุช...');

        $permissions = [
            'admin.dashboard.view',
            'admin.users.manage',
            'admin.stores.manage',
            'admin.organizations.manage',
            'admin.beneficiaries.manage',
            'admin.coupons.manage',
            'admin.transactions.view',
            'admin.reports.view',
            'admin.settings.manage',
            'store.dashboard.view',
            'store.transactions.manage',
            'store.coupons.redeem',
            'beneficiary.dashboard.view',
            'beneficiary.requests.create',
            'beneficiary.coupons.view',
            'charity.dashboard.view',
            'charity.campaigns.manage',
            'charity.requests.manage',
            'charity.reports.create',
        ];

        foreach ($permissions as $permission) {
            $parts = explode('.', $permission);
            $module = $parts[0]; // admin, store, beneficiary, charity
            $action = isset($parts[2]) ? $parts[2] : 'general'; // view, manage, create, etc.
            
            Permission::firstOrCreate([
                'name' => $permission,
                'display_name' => $permission,
                'module' => $module,
                'action' => $action,
                'description' => "ุฅุฐู $permission",
            ]);
        }

        $this->command->info('โ ุชู ุฅูุดุงุก ' . count($permissions) . ' ุฅุฐู');
    }

    private function createOrganizations(): void
    {
        $this->command->info('๐ข ุฅูุดุงุก ุงูููุธูุงุช ูุงููุคุณุณุงุช ุงูุฎูุฑูุฉ...');

        // ููุธูุงุช ุฎูุฑูุฉ
        $charityOrgs = Organization::factory(8)->charity()->active()->create();
        
        // ูุคุณุณุงุช ุญููููุฉ
        $govOrgs = Organization::factory(3)->government()->active()->create();
        
        // ููุธูุงุช ุบูุฑ ุฑุจุญูุฉ
        $nonProfitOrgs = Organization::factory(4)->nonProfit()->active()->create();
        
        // ููุธูุงุช ุฏูููุฉ
        $intlOrgs = Organization::factory(2)->international()->active()->create();

        // ุฅูุดุงุก ุชูุงุตูู ุงููุคุณุณุงุช ุงูุฎูุฑูุฉ
        foreach ($charityOrgs as $org) {
            CharityOrganization::factory()->create([
                'organization_id' => $org->id,
            ]);
        }

        // ุฅูุดุงุก ุจุนุถ ุงููุคุณุณุงุช ุงูุฎูุฑูุฉ ูุน ุชุฑุงุฎูุต ููุชููุฉ ุฃู ูุฑูุจุฉ ุงูุงูุชูุงุก
        $expiredCharities = Organization::factory(2)->charity()->create();
        foreach ($expiredCharities as $org) {
            CharityOrganization::factory()->withExpiredLicense()->create([
                'organization_id' => $org->id,
            ]);
        }

        $expiringSoonCharities = Organization::factory(3)->charity()->create();
        foreach ($expiringSoonCharities as $org) {
            CharityOrganization::factory()->withExpiringSoonLicense()->create([
                'organization_id' => $org->id,
            ]);
        }

        $this->command->info('โ ุชู ุฅูุดุงุก ' . Organization::count() . ' ููุธูุฉ');
        $this->command->info('โ ุชู ุฅูุดุงุก ' . CharityOrganization::count() . ' ูุคุณุณุฉ ุฎูุฑูุฉ');
    }

    private function createStores(): void
    {
        $this->command->info('๐ช ุฅูุดุงุก ุงููุชุงุฌุฑ...');

        // ูุชุงุฌุฑ ุจูุงูุฉ
        Store::factory(8)->grocery()->active()->withPhysicalLocation()->create();
        
        // ุตูุฏููุงุช
        Store::factory(6)->pharmacy()->active()->withPhysicalLocation()->create();
        
        // ูุทุงุนู
        Store::factory(5)->restaurant()->active()->withOnlineOrders()->create();
        
        // ูุชุงุฌุฑ ูุชููุนุฉ
        Store::factory(10)->active()->create();
        
        // ูุชุงุฌุฑ ุบูุฑ ูุดุทุฉ
        Store::factory(3)->inactive()->create();

        $this->command->info('โ ุชู ุฅูุดุงุก ' . Store::count() . ' ูุชุฌุฑ');
    }

    private function createBeneficiaries(): void
    {
        $this->command->info('๐ฅ ุฅูุดุงุก ุงููุณุชููุฏูู ููููุงุชูู...');

        // ูุณุชุฎุฏููู ูุณุชููุฏูู
        $beneficiaryUsers = User::factory(50)->asBeneficiary()->create();

        foreach ($beneficiaryUsers as $user) {
            // ุฅูุดุงุก ูู ุงููุธุงู ุงููุฏูู (ููููุจููุงุช ูุงููุนุงููุงุช)
            Beneficiary::factory()->create([
                'user_id' => $user->id,
            ]);
            
            // ุฅูุดุงุก ูู ุงููุธุงู ุงูุฌุฏูุฏ (ููุชูุงุตูู ุงููุญุณูุฉ)
            BeneficiaryProfile::factory()->create([
                'user_id' => $user->id,
            ]);
        }

        // ูุณุชููุฏูู ุจุญุงูุงุช ุฎุงุตุฉ
        $specialCases = User::factory(15)->asBeneficiary()->create();

        foreach ($specialCases as $user) {
            // ุงููุธุงู ุงููุฏูู
            Beneficiary::factory()->create(['user_id' => $user->id]);
            
            // ุงููุธุงู ุงูุฌุฏูุฏ ูุน ุญุงูุงุช ุฎุงุตุฉ
            $profileType = rand(1, 4);
            switch ($profileType) {
                case 1:
                    BeneficiaryProfile::factory()->largeFamily()->verified()->create(['user_id' => $user->id]);
                    break;
                case 2:
                    BeneficiaryProfile::factory()->withSpecialNeeds()->verified()->create(['user_id' => $user->id]);
                    break;
                case 3:
                    BeneficiaryProfile::factory()->elderly()->verified()->create(['user_id' => $user->id]);
                    break;
                case 4:
                    BeneficiaryProfile::factory()->singleMother()->pending()->create(['user_id' => $user->id]);
                    break;
            }
        }

        // ูุณุชููุฏูู ูู ุญุงูุฉ ุงูุชุธุงุฑ ุฃู ูุฑููุถูู
        $pendingUsers = User::factory(10)->asBeneficiary()->create();
        foreach ($pendingUsers as $user) {
            Beneficiary::factory()->create(['user_id' => $user->id]);
            BeneficiaryProfile::factory()->pending()->create(['user_id' => $user->id]);
        }

        $rejectedUsers = User::factory(5)->asBeneficiary()->create();
        foreach ($rejectedUsers as $user) {
            Beneficiary::factory()->create(['user_id' => $user->id]);
            BeneficiaryProfile::factory()->rejected()->create(['user_id' => $user->id]);
        }

        $this->command->info('โ ุชู ุฅูุดุงุก ' . User::where('role', 'beneficiary')->count() . ' ูุณุชููุฏ');
        $this->command->info('โ ุชู ุฅูุดุงุก ' . Beneficiary::count() . ' ููู ูุณุชููุฏ (ุงููุธุงู ุงููุฏูู)');
        $this->command->info('โ ุชู ุฅูุดุงุก ' . BeneficiaryProfile::count() . ' ููู ูุณุชููุฏ (ุงููุธุงู ุงูุฌุฏูุฏ)');
    }

    private function createRequests(): void
    {
        $this->command->info('๐ ุฅูุดุงุก ุงูุทูุจุงุช...');

        $beneficiaries = User::where('role', 'beneficiary')->pluck('id')->toArray();
        $organizations = Organization::pluck('id')->toArray();

        // ุทูุจุงุช ูุชููุนุฉ
        foreach ($beneficiaries as $beneficiaryId) {
            $requestCount = rand(1, 4);
            for ($i = 0; $i < $requestCount; $i++) {
                $requestType = rand(1, 5);
                switch ($requestType) {
                    case 1:
                        RequestModel::factory()->foodAssistance()->create([
                            'user_id' => $beneficiaryId,
                        ]);
                        break;
                    case 2:
                        RequestModel::factory()->medicalAssistance()->create([
                            'user_id' => $beneficiaryId,
                        ]);
                        break;
                    case 3:
                        RequestModel::factory()->housingAssistance()->create([
                            'user_id' => $beneficiaryId,
                        ]);
                        break;
                    case 4:
                        RequestModel::factory()->educationalAssistance()->create([
                            'user_id' => $beneficiaryId,
                        ]);
                        break;
                    case 5:
                        RequestModel::factory()->urgent()->create([
                            'user_id' => $beneficiaryId,
                        ]);
                        break;
                }
            }
        }

        $this->command->info('โ ุชู ุฅูุดุงุก ' . RequestModel::count() . ' ุทูุจ');
    }

    private function createCoupons(): void
    {
        $this->command->info('๐ซ ุฅูุดุงุก ุงูููุจููุงุช...');

        $organizations = Organization::pluck('id')->toArray();
        $campaigns = Campaign::pluck('id')->toArray();

        // ููุจููุงุช ูุชููุนุฉ
        Coupon::factory(100)->create([
            'organization_id' => function() use ($organizations) {
                return $this->getRandomElement($organizations);
            },
            'campaign_id' => function() use ($campaigns) {
                return $this->getRandomElement($campaigns);
            },
        ]);

        // ููุจููุงุช ุนุงููุฉ ุงููููุฉ
        Coupon::factory(20)->highValue()->create([
            'organization_id' => function() use ($organizations) {
                return $this->getRandomElement($organizations);
            },
            'campaign_id' => function() use ($campaigns) {
                return $this->getRandomElement($campaigns);
            },
        ]);

        // ููุจููุงุช ููุชููุฉ ุงูุตูุงุญูุฉ
        Coupon::factory(30)->expired()->create([
            'organization_id' => function() use ($organizations) {
                return $this->getRandomElement($organizations);
            },
            'campaign_id' => function() use ($campaigns) {
                return $this->getRandomElement($campaigns);
            },
        ]);

        $this->command->info('โ ุชู ุฅูุดุงุก ' . Coupon::count() . ' ููุจูู');
    }

    private function createTransactions(): void
    {
        $this->command->info('๐ณ ุฅูุดุงุก ุงููุนุงููุงุช...');

        $beneficiaries = User::where('role', 'beneficiary')->pluck('id')->toArray();
        $storeUsers = User::where('role', 'store')->pluck('id')->toArray();
        $organizations = Organization::pluck('id')->toArray();
        $coupons = Coupon::pluck('id')->toArray();

        // ูุนุงููุงุช ุงุณุชุจุฏุงู ููุจููุงุช ููุชููุฉ
        Transaction::factory(100)->couponRedemption()->completed()->create([
            'beneficiary_id' => function() use ($beneficiaries) {
                return $this->getRandomElement($beneficiaries);
            },
            'store_id' => function() use ($storeUsers) {
                return $this->getRandomElement($storeUsers);
            },
            'organization_id' => function() use ($organizations) {
                return $this->getRandomElement($organizations);
            },
            'coupon_id' => function() use ($coupons) {
                return $this->getRandomElement($coupons);
            },
        ]);

        // ูุนุงููุงุช ูู ุงูุชุธุงุฑ
        Transaction::factory(20)->pending()->create([
            'beneficiary_id' => function() use ($beneficiaries) {
                return $this->getRandomElement($beneficiaries);
            },
            'store_id' => function() use ($storeUsers) {
                return $this->getRandomElement($storeUsers);
            },
            'organization_id' => function() use ($organizations) {
                return $this->getRandomElement($organizations);
            },
            'coupon_id' => function() use ($coupons) {
                return $this->getRandomElement($coupons);
            },
        ]);

        // ุชุจุฑุนุงุช
        Transaction::factory(30)->donation()->completed()->create([
            'beneficiary_id' => null,
            'organization_id' => function() use ($organizations) {
                return $this->getRandomElement($organizations);
            },
        ]);

        $this->command->info('โ ุชู ุฅูุดุงุก ' . Transaction::count() . ' ูุนุงููุฉ');
    }

    private function createCampaigns(): void
    {
        $this->command->info('๐ข ุฅูุดุงุก ุงูุญููุงุช...');

        $charityUsers = User::where('role', 'charity')->pluck('id')->toArray();

        // ุงูุชุฃูุฏ ูู ูุฌูุฏ ูุณุชุฎุฏููู ุฎูุฑููู
        if (empty($charityUsers)) {
            $charityUsers = User::factory(5)->asCharity()->create()->pluck('id')->toArray();
        }

        // ุญููุงุช ูุดุทุฉ
        Campaign::factory(15)->active()->create([
            'charity_id' => function() use ($charityUsers) {
                return $this->getRandomElement($charityUsers);
            },
        ]);

        // ุญููุงุช ููุชููุฉ
        Campaign::factory(10)->completed()->create([
            'charity_id' => function() use ($charityUsers) {
                return $this->getRandomElement($charityUsers);
            },
        ]);

        // ุญููุงุช ูุชููุนุฉ
        Campaign::factory(20)->create([
            'charity_id' => function() use ($charityUsers) {
                return $this->getRandomElement($charityUsers);
            },
        ]);

        $this->command->info('โ ุชู ุฅูุดุงุก ' . Campaign::count() . ' ุญููุฉ');
    }

    private function createContactMessages(): void
    {
        $this->command->info('๐ง ุฅูุดุงุก ุฑุณุงุฆู ุงูุงุชุตุงู...');

        // ุฑุณุงุฆู ุบูุฑ ููุฑูุกุฉ
        ContactMessage::factory(20)->unread()->create();
        
        // ุฑุณุงุฆู ููุฑูุกุฉ
        ContactMessage::factory(30)->read()->create();
        
        // ุฑุณุงุฆู ุชู ุงูุฑุฏ ุนูููุง
        ContactMessage::factory(25)->replied()->create();

        $this->command->info('โ ุชู ุฅูุดุงุก ' . ContactMessage::count() . ' ุฑุณุงูุฉ ุงุชุตุงู');
    }

    private function createRelationships(): void
    {
        $this->command->info('๐ ุฅูุดุงุก ุงูุนูุงูุงุช ุจูู ุงูุฌุฏุงูู...');

        // ุฑุจุท ุงููุณุชุฎุฏููู ุจุงููุชุงุฌุฑ (ุงููุธุงู ุงูุฌุฏูุฏ)
        $stores = Store::all();
        $storeUsers = User::factory(20)->asStoreUser()->create();

        foreach ($storeUsers as $user) {
            $store = $stores->random();
            try {
                $store->addUser($user->id, 'owner', true);
            } catch (\Exception $e) {
                // ูู ุญุงูุฉ ูุดู ุงูุนูููุฉุ ูุชุฌุงูููุง ููุชุงุจุนุฉ ุฅูุดุงุก ุงูุจูุงูุงุช
                $this->command->warn("ุชุญุฐูุฑ: ูุดู ูู ุฑุจุท ุงููุณุชุฎุฏู {$user->id} ุจุงููุชุฌุฑ {$store->id}");
            }
        }

        // ุฅุถุงูุฉ ูุณุชุฎุฏููู ุฅุถุงูููู ูููุชุงุฌุฑ
        foreach ($stores->take(10) as $store) {
            $additionalUsers = User::factory(rand(1, 2))->asStoreUser()->create();
            foreach ($additionalUsers as $user) {
                try {
                    $role = ['manager', 'employee'][rand(0, 1)];
                    $store->addUser($user->id, $role, false);
                } catch (\Exception $e) {
                    // ูู ุญุงูุฉ ูุดู ุงูุนูููุฉุ ูุชุฌุงูููุง
                }
            }
        }

        // ุฑุจุท ุงููุณุชุฎุฏููู ุจุงูููุธูุงุช (ุงููุธุงู ุงูุฌุฏูุฏ)
        $organizations = Organization::all();
        $orgUsers = User::factory(15)->asCharity()->create();

        foreach ($orgUsers as $user) {
            $organization = $organizations->random();
            try {
                $organization->addUser($user->id, 'admin', true);
            } catch (\Exception $e) {
                // ูู ุญุงูุฉ ูุดู ุงูุนูููุฉุ ูุชุฌุงูููุง
                $this->command->warn("ุชุญุฐูุฑ: ูุดู ูู ุฑุจุท ุงููุณุชุฎุฏู {$user->id} ุจุงูููุธูุฉ {$organization->id}");
            }
        }

        // ุฅุถุงูุฉ ุฃุนุถุงุก ููููุธูุงุช
        foreach ($organizations->take(8) as $organization) {
            $members = User::factory(rand(2, 4))->asCharity()->create();
            foreach ($members as $user) {
                try {
                    $role = ['member', 'volunteer'][rand(0, 1)];
                    $organization->addUser($user->id, $role, false);
                } catch (\Exception $e) {
                    // ูู ุญุงูุฉ ูุดู ุงูุนูููุฉุ ูุชุฌุงูููุง
                }
            }
        }

        $this->command->info('โ ุชู ุฅูุดุงุก ุงูุนูุงูุงุช ุจูู ุงููุณุชุฎุฏููู ูุงููุชุงุฌุฑ ูุงูููุธูุงุช');
    }

    private function getRandomElement(array $array)
    {
        return $array[array_rand($array)];
    }
} 